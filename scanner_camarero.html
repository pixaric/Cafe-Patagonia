<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Scanner Camarero</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  
    <style>
  :root {
    --azul: #0078D4;
    --verde: #28a745;
    --amarillo: #ffc107;
    --gris-claro: #f9f9f9;
    --gris-borde: #ddd;
    --fuente: 'Segoe UI', sans-serif;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: var(--fuente);
    background: var(--gris-claro);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  h2, h3 {
    color: #333;
    text-align: center;
    margin-bottom: 15px;
  }

  label {
    font-weight: bold;
    margin-bottom: 5px;
    display: block;
  }

  input[type="text"] {
    padding: 10px;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid var(--gris-borde);
    width: 100%;
    max-width: 300px;
    margin-bottom: 10px;
  }

  #mensajeMesa {
    color: red;
    font-size: 14px;
    margin-bottom: 10px;
    text-align: center;
  }

  #escanearBtn {
    background-color: var(--azul);
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    border-radius: 6px;
    cursor: pointer;
    margin-bottom: 20px;
    width: 100%;
    max-width: 300px;
  }

  #reader {
    width: 100%;
    max-width: 320px;
    margin-bottom: 20px;
    border: 2px solid var(--gris-borde);
    border-radius: 8px;
    background: white;
    display: none;
  }

  #pedido {
    width: 100%;
    max-width: 500px;
    background: #fff;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--gris-borde);
    font-size: 16px;
    white-space: pre-wrap;
    margin-bottom: 20px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }

  .acciones {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    width: 100%;
    max-width: 500px;
  }

  .acciones button {
    flex: 1 1 45%;
    padding: 10px;
    font-size: 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    min-width: 130px;
  }

  #guardarBtn {
    background-color: var(--verde);
    color: white;
  }

  #imprimirBtn {
    background-color: var(--amarillo);
    color: black;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media screen and (max-width: 480px) {
    input[type="text"], #escanearBtn {
      max-width: 100%;
    }

    .acciones button {
      flex: 1 1 100%;
    }
  }
</style>

</head>
<body>
  <h2>üì∑ Scanner Camarero</h2>
  <label for="mesaInput">N√∫mero de mesa:</label>
<input type="text" id="mesaInput" placeholder="Ej. 5" style="margin-bottom: 20px; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; width: 200px;">
<div id="mensajeMesa" style="color: red; margin-bottom: 10px;"></div>

  <button id="escanearBtn">Escanear QR</button>
  <div id="reader"></div>
<h3>üßæ Pedido Escaneado</h3>
  <pre id="pedido">Esperando escaneo...</pre>

  <label for="comentarioInput">Comentarios:</label>
<textarea id="comentarioInput" placeholder="Ej. sin az√∫car, urgente..." rows="3" style="margin-bottom: 20px; padding: 10px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; width: 100%; max-width: 300px;"></textarea>

  <div class="acciones">
    <button id="guardarBtn" disabled>üíæ Guardar en BD</button>
    <button id="imprimirBtn" disabled>üñ®Ô∏è Imprimir</button>
  </div>

  

  <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js"
  }
}
</script>
<script type="module">
  if (sessionStorage.getItem("usuarioAutenticado") !== "true") {
  window.location.href = "login.html";
}


import { ref, push } from "firebase/database";
import { db } from "./firebase-config.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFdTREJvegUdsOUc7A0-NTOvKemQmTGyI",
  authDomain: "pedidosqr-34bea.firebaseapp.com",
  databaseURL: "https://pedidosqr-34bea-default-rtdb.firebaseio.com",
  projectId: "pedidosqr-34bea",
  storageBucket: "pedidosqr-34bea.appspot.com",
  messagingSenderId: "743534119824",
  appId: "1:743534119824:web:17cf79d3b6952380084115"
};

import { getAuth, onAuthStateChanged } from "firebase/auth";

const auth = getAuth();
onAuthStateChanged(auth, (user) => {
  if (!user) {
    window.location.href = "login.html";
  }
});




let contenidoEscaneado = "";
let escaneoActivo = false;
let html5QrCode = null;



const pedidoEl = document.getElementById("pedido");
const guardarBtn = document.getElementById("guardarBtn");
const imprimirBtn = document.getElementById("imprimirBtn");

function procesarQR(texto) {
  contenidoEscaneado = texto;
  actualizarVistaPedido();
  guardarBtn.disabled = false;
  imprimirBtn.disabled = false;
}



document.getElementById("escanearBtn").addEventListener("click", () => {
  const mesa = document.getElementById("mesaInput").value.trim();
  const mensajeMesa = document.getElementById("mensajeMesa");

  if (!mesa) {
    mensajeMesa.textContent = "‚ö†Ô∏è Por favor, ingresa el n√∫mero de mesa antes de escanear.";
    return;
  }

  mensajeMesa.textContent = ""; // Limpiar mensaje si todo est√° bien

  if (escaneoActivo) return;

  escaneoActivo = true;
  document.getElementById("reader").style.display = "block";

  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      html5QrCode.stop().then(() => {
        escaneoActivo = false;
        document.getElementById("reader").style.display = "none";

        const ticketFinal = `Mesa: ${mesa}\n\n${decodedText}`;
        procesarQR(ticketFinal);
      }).catch(err => {
        console.error("Error al detener el escaneo:", err);
      });
    },
    (errorMessage) => {
      console.warn("Error de escaneo:", errorMessage);
    }
  );
});




guardarBtn.addEventListener("click", () => {
  if (!contenidoEscaneado) return;

  const comentario = document.getElementById("comentarioInput").value.trim();

  const lineas = contenidoEscaneado.split("\n").map(l => l.trim()).filter(l => l);
  const mesaLine = lineas.find(l => l.toLowerCase().startsWith("mesa"));
  const mesa = mesaLine ? mesaLine.split(":")[1].trim() : "desconocida";

  const productos = lineas
    .filter(l => !l.toLowerCase().startsWith("mesa"))
    .map(l => {
      const partes = l.split("x");
      const producto = partes[0].trim();
      const cantidad = partes[1] ? parseInt(partes[1].trim()) : 1;
      return { producto, cantidad };
    });

  const pedido = {
    fecha: new Date().toLocaleDateString(),
    hora: new Date().toLocaleTimeString(),
    mesa,
    comentario,
    productos
  };

  push(ref(db, "pedidos"), pedido)
    .then(() => {
      guardarBtn.disabled = true;
      guardarBtn.textContent = "‚úÖ Guardado";
      alert("Pedido guardado correctamente");
    })
    .catch(err => {
      console.error("Error al guardar:", err);
      alert("‚ùå No se pudo guardar el pedido");
    });
});


function actualizarVistaPedido() {
  const comentario = document.getElementById("comentarioInput").value.trim();
  const textoFinal = comentario
    ? `${contenidoEscaneado}\n\nComentario: ${comentario}`
    : contenidoEscaneado;
login
  pedidoEl.textContent = textoFinal;
}
document.getElementById("comentarioInput").addEventListener("input", actualizarVistaPedido);


imprimirBtn.addEventListener("click", () => {
  window.print();
});

html5QrCode.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  (decodedText) => {
    html5QrCode.stop().then(() => {
      escaneoActivo = false;
      document.getElementById("reader").style.display = "none";
      procesarQR(decodedText);
    }).catch(err => {
      console.error("Error al detener el escaneo:", err);
    });
  },
  (errorMessage) => {
    // No cerrar el esc√°ner aqu√≠
    console.warn("Error de escaneo:", errorMessage);
  }
);



(errorMessage) => {
  escaneoActivo = false;
}



</script>

</body>
</html>