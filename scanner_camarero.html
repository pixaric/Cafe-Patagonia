<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Scanner Camarero</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      padding: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h2 {
      margin-bottom: 20px;
      color: #333;
    }

    #escanearBtn {
      background-color: #0078D4;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 20px;
    }

    #reader {
      width: 320px;
      margin-bottom: 30px;
      display: none;
      border: 2px solid #ccc;
      border-radius: 8px;
      background: white;
    }

    #pedido {
      width: 100%;
      max-width: 500px;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      white-space: pre-wrap;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .acciones {
      display: flex;
      gap: 15px;
    }

    .acciones button {
      padding: 10px 20px;
      font-size: 15px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
    }

    #guardarBtn {
      background-color: #28a745;
      color: white;
    }

    #imprimirBtn {
      background-color: #ffc107;
      color: black;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h2>üì∑ Scanner Camarero</h2>
  <button id="escanearBtn">Escanear QR</button>
  <div id="reader"></div>
<h3>üßæ Pedido Escaneado</h3>
  <pre id="pedido">Esperando escaneo...</pre>

  <div class="acciones">
    <button id="guardarBtn" disabled>üíæ Guardar en BD</button>
    <button id="imprimirBtn" disabled>üñ®Ô∏è Imprimir</button>

    <button id="telegramBtn" disabled>üì® Enviar por Telegram</button>

  </div>

 <script type="importmap">
{
  "imports": {
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/database": "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js",
    "./firebase-config.js": "./js/firebase-config.js"
  }
}
</script>

</script>
<script type="module">
import { ref, push } from "firebase/database";
import { db } from "./firebase-config.js";






let contenidoEscaneado = "";
let escaneoActivo = false;
let html5QrCode = null;



const pedidoEl = document.getElementById("pedido");
const guardarBtn = document.getElementById("guardarBtn");
const imprimirBtn = document.getElementById("imprimirBtn");

function procesarQR(texto) {
  contenidoEscaneado = texto;
  pedidoEl.textContent = texto;
  guardarBtn.disabled = false;
  imprimirBtn.disabled = false;
  telegramBtn.disabled = false;

}

document.getElementById("escanearBtn").addEventListener("click", () => {
  if (escaneoActivo) return;

  escaneoActivo = true;
  document.getElementById("reader").style.display = "block";

  html5QrCode = new Html5Qrcode("reader");

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    (decodedText) => {
      setTimeout(() => {
        if (html5QrCode) {
          html5QrCode.stop().then(() => {
            escaneoActivo = false;
            document.getElementById("reader").style.display = "none";
            procesarQR(decodedText);
          }).catch(err => {
            console.error("Error al detener el escaneo:", err);
          });
        }
      }, 300);
    },
    (errorMessage) => {
      console.warn("Error de escaneo:", errorMessage);
    }
  );
});




guardarBtn.addEventListener("click", () => {
  if (!contenidoEscaneado) return;

  const pedido = {
    ticketText: contenidoEscaneado,
    timestamp: Date.now(),
    estado: "pendiente"
  };

  push(ref(db, "pedidos"), pedido)
    .then(() => {
      guardarBtn.disabled = true;
      guardarBtn.textContent = "‚úÖ Guardado";
      alert("Pedido guardado en Firebase");
    })
    .catch(err => {
      console.error("Error al guardar:", err);
      alert("‚ùå No se pudo guardar el pedido");
    });
});



imprimirBtn.addEventListener("click", () => {
  window.print();
});

setTimeout(() => {
  html5QrCode.stop();
  escaneoActivo = false;
  document.getElementById("reader").style.display = "none";
  procesarQR(decodedText);
}, 300);

(errorMessage) => {
  escaneoActivo = false;
}

const telegramBtn = document.getElementById("telegramBtn");

telegramBtn.addEventListener("click", () => {
  if (!contenidoEscaneado) return;

  const mensaje = encodeURIComponent(contenidoEscaneado);
  const telegramURL = `https://t.me/share/url?url=&text=${mensaje}`;
  window.open(telegramURL, "_blank");
});


</script>

</body>
</html>
